#!/bin/bash
URL=https://anduin.linuxfromscratch.org/BLFS/qtwebengine/qtwebengine-5.15.10.tar.xz
TAR=qtwebengine-5.15.10.tar.xz
DIR=qtwebengine-5.15.10
PACKAGE=qtwebengine

# Get Package

cd /blfs/builds
wget  https://www.linuxfromscratch.org/patches/blfs/svn/qtwebengine-5.15.10-build_fixes-1.patch
wget $URL
tar -xvf $TAR
cd $DIR

# Build

ln -svf /usr/bin/python{2,}
patch -Np1 -i ../qtwebengine-5.15.10-build_fixes-1.patch
mkdir -pv .git src/3rdparty/chromium/.git

sed -e '/^MODULE_VERSION/s/5.*/5.15.5/' -i .qmake.conf

find -type f -name "*.pr[io]" |
  xargs sed -i -e 's|INCLUDEPATH += |&$$QTWEBENGINE_ROOT/include |'
  

sed -e '/link_pulseaudio/s/false/true/' \
    -i src/3rdparty/chromium/media/media_options.gni
    
    
sed -i 's/NINJAJOBS/NINJA_JOBS/' src/core/gn_run.pro

mkdir build &&
cd    build &&
qmake .. -- -system-ffmpeg -webengine-icu &&
make -j16




# Install
sudo porg -lp $PACKAGE "make install && find $QT5DIR/ -name \*.prl \
   -exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d' {} \; && rm -v /usr/bin/python"
cd /pkgs
sudo ./dir.sh $PACKAGE


sudo echo "nodejs nss pciutils python2 qt5 alsa-lib pulseaudio ffmpeg icu libxml2 libwebp libxslt opus libevent mitkrb" > /pkgs/$PACKAGE/depends
sudo tar -cvf $PACKAGE.tar.xz $PACKAGE
sudo cp $PACKAGE.tar.xz /finished


cd /blfs/builds
sudo rm -r $DIR


